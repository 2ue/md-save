# 产品需求文档 (PRD)
## Web Clipper 2.0 - 完整重构版本

**文档版本**：v1.0
**创建日期**：2025-01-25
**作者**：产品需求分析
**项目代号**：Clipper V2

---

## 一、产品概述

### 1.1 产品定位

一款**轻量级、隐私优先、支持多端同步**的网页摘录工具，帮助用户快速保存、组织和管理网页内容，支持本地存储和 WebDAV 远端同步。

**核心价值主张**：
- 🚀 **快速**：1-2 步完成摘录（右键菜单、快捷键）
- 🎯 **灵活**：全页/多段选择，保存时决定位置
- 🔒 **隐私**：本地优先，数据自主权
- 🌐 **同步**：WebDAV 自建服务器，跨设备一致
- 🧩 **可扩展**：插件式架构，未来支持 GitHub/Notion 等

### 1.2 目标用户

**主要用户群体**：
1. **知识工作者**：需要摘录技术文档、研究资料
2. **内容创作者**：收集灵感、整理素材
3. **学生/研究者**：保存学习资料、论文笔记
4. **隐私敏感用户**：不信任云服务，需要本地存储

**用户画像**：
- 年龄：25-45 岁
- 职业：程序员、设计师、作家、研究员
- 技术水平：中高级（熟悉 Markdown、WebDAV）
- 痛点：现有工具过于复杂或缺乏隐私保护

### 1.3 产品目标

**短期目标（3 个月）**：
- 实现核心摘录功能（全页/局部/多段）
- 支持本地和 WebDAV 保存
- 元数据系统（标签、分类、笔记）
- 历史记录管理

**中期目标（6 个月）**：
- 模板系统和社区模板库
- 图片批量下载和管理
- 配置和历史记录云同步

**长期目标（12 个月）**：
- 插件式架构支持第三方存储（GitHub、Notion）
- AI 辅助标签建议和摘要
- 多语言支持

---

## 二、核心需求

### 2.1 功能需求列表

#### P0 级别（必须有）

**FR-001：快速复制标题和 URL**
- **描述**：右键菜单或快捷键快速复制当前页面的标题和 URL
- **输入**：当前页面
- **输出**：格式化文本（`[标题](URL)` Markdown 格式）
- **验收标准**：
  - 右键菜单显示"复制链接（Markdown）"选项
  - 快捷键 Ctrl+Shift+C 触发复制
  - 支持自定义复制格式模板

**FR-002：全页面一键摘录**
- **描述**：提取页面主要内容，转换为 Markdown，处理懒加载
- **输入**：当前页面 URL
- **输出**：Markdown 文件
- **特殊要求**：
  - 自动滚动页面触发懒加载图片
  - 清理广告、侧边栏、导航栏
  - 保留语义结构（标题层级、列表、引用）
- **验收标准**：
  - 能正确提取至少 90% 的主要内容
  - 处理常见懒加载方式（IntersectionObserver、scroll 事件）
  - 转换后 Markdown 格式正确

**FR-003：局部内容摘录（单段/多段）**
- **描述**：用户选择页面中的一个或多个区域进行摘录
- **输入**：用户选中的文本或点击的元素
- **输出**：Markdown 文件（包含选中的内容）
- **特殊要求**：
  - 支持文本选择后右键"摘录选中内容"
  - 支持点击元素模式（高亮可选元素）
  - **支持多段选择**（Shift+点击累加选择）
- **验收标准**：
  - 文本选择模式：支持跨元素选择
  - 元素选择模式：高亮显示可选区域
  - 多段选择模式：清晰显示已选择的片段
  - 选择顺序保持一致

**FR-004：保存位置灵活选择**
- **描述**：保存时由用户决定保存到哪里（不是预设默认位置）
- **输入**：摘录内容 + 用户选择
- **输出**：保存到指定位置
- **特殊要求**：
  - 提供"本地"和"WebDAV"两个选项
  - 本地保存：触发浏览器下载对话框（用户选择目录）
  - WebDAV 保存：显示目录树选择器
  - 记住上次选择的位置（作为建议）
- **验收标准**：
  - 保存前必须选择位置
  - 支持新建目录（WebDAV）
  - 显示完整保存路径预览

**FR-005：保存前编辑和元数据**
- **描述**：保存前提供全面的编辑和设置界面
- **输入**：原始摘录内容
- **输出**：用户确认后的最终内容
- **必须包含的编辑项**：
  - 文件名（支持目录结构，如 `2025/01/article.md`）
  - 内容（Markdown 编辑器，支持预览）
  - 标签（多标签输入，自动补全）
  - 分类（下拉选择或新建）
  - 备注（可选的用户笔记）
  - 保存位置（本地/WebDAV + 目录选择）
- **验收标准**：
  - 所有编辑实时生效
  - 显示完整保存路径预览（`/notes/2025/01/article.md`）
  - 支持 Markdown 预览切换

**FR-006：历史记录管理**
- **描述**：记录所有摘录历史，支持搜索、过滤、删除
- **输入**：历史记录列表
- **输出**：筛选后的记录
- **必须包含的信息**：
  - 标题、URL、摘录时间
  - 保存位置（本地路径或 WebDAV 路径）
  - 标签和分类
  - 内容预览（前 100 字符）
  - 文件大小、图片数量
- **验收标准**：
  - 支持按标题、URL、标签搜索
  - 支持按日期、分类过滤
  - 支持批量删除
  - 点击记录可跳转到原始 URL

**FR-007：WebDAV 远端保存**
- **描述**：支持保存到 WebDAV 服务器
- **输入**：WebDAV 配置 + 文件内容
- **输出**：上传到服务器
- **配置项**：
  - 服务器 URL
  - 用户名/密码
  - 认证方式（Basic/Digest）
  - 基础路径
- **验收标准**：
  - 测试连接功能
  - 上传进度反馈
  - 文件冲突检测和提示
  - 支持创建多级目录

#### P1 级别（应该有）

**FR-008：图片批量下载**
- **描述**：下载页面中的图片，支持全部或选中区域的图片
- **输入**：页面或选中区域
- **输出**：图片文件 + Markdown 中的本地路径
- **两种模式**：
  - 全页模式：下载所有图片
  - 选区模式：只下载选中内容中的图片
- **特殊要求**：
  - 后台静默下载（不阻塞保存操作）
  - 下载失败回退到原始 URL
  - 图片保存到 `./assets/` 子目录
- **验收标准**：
  - 支持常见图片格式（jpg/png/gif/webp/svg）
  - 处理跨域图片（通过 Background Script）
  - 下载进度反馈

**FR-009：配置同步**
- **描述**：将插件配置同步到 WebDAV，多设备共享
- **输入**：当前配置
- **输出**：上传/下载配置文件
- **同步内容**：
  - 模板配置
  - 标签库和分类
  - WebDAV 配置（密码加密）
  - UI 偏好设置
- **验收标准**：
  - 手动同步按钮
  - 浏览器启动时自动下载（可选）
  - 配置冲突提示（选择保留哪个版本）

**FR-010：历史记录同步和合并**
- **描述**：将历史记录同步到 WebDAV，本地和远端数据合并
- **输入**：本地历史 + 远端历史
- **输出**：合并后的历史记录
- **合并策略**：
  - 按 ID 去重（nanoid 全局唯一）
  - 按时间戳排序
  - 冲突解决：保留最新的记录
- **验收标准**：
  - 手动同步按钮
  - 自动同步（浏览器启动时）
  - 显示同步状态（同步中/成功/失败）
  - 同步日志（上传 X 条，下载 Y 条）

**FR-011：模板系统**
- **描述**：支持多套模板，不同场景使用不同格式
- **输入**：模板配置
- **输出**：格式化的 Markdown 内容
- **内置模板**：
  - 默认模板（简洁）
  - 技术文档（带 frontmatter）
  - 博客文章（带元信息）
  - 新闻摘要（简洁版）
- **变量支持**：
  - `{{title}}`、`{{url}}`、`{{domain}}`
  - `{{content}}`、`{{tags}}`、`{{category}}`
  - `{{date}}`、`{{time}}`、`{{YYYY}}`、`{{MM}}`、`{{DD}}` 等
- **验收标准**：
  - 保存时选择模板
  - 支持自定义模板
  - 模板预览功能
  - 导入/导出模板

#### P2 级别（可以有）

**FR-012：右键菜单快捷操作**
- 复制链接（Markdown）
- 快速保存选中内容（使用默认配置）
- 保存整个页面
- 保存并编辑

**FR-013：键盘快捷键**
- Ctrl+Shift+S：快速保存
- Ctrl+Shift+E：保存并编辑
- Ctrl+Shift+C：复制链接

**FR-014：标签自动建议**
- 基于页面内容自动建议标签
- 基于历史记录的标签频率
- 智能补全

**FR-015：批量操作**
- 批量导出历史记录
- 批量修改标签
- 批量删除

### 2.2 非功能需求

#### NFR-001：性能要求
- 全页摘录：< 5 秒（包括懒加载处理）
- 保存操作：< 2 秒（不含图片下载）
- 历史记录加载：< 1 秒（1000 条以内）
- 图片下载：不阻塞保存操作

#### NFR-002：兼容性要求
- 浏览器：Chrome 110+、Firefox 115+、Edge 110+
- Manifest V3 支持
- 移动端浏览器：Firefox Mobile、Safari iOS（基础功能）

#### NFR-003：安全要求
- WebDAV 密码加密存储（AES-256）
- 不上传用户数据到第三方服务器
- 敏感信息不出现在日志中

#### NFR-004：可用性要求
- 首次使用引导（5 步完成配置）
- 错误信息友好（不显示技术细节）
- 所有操作可撤销（Undo）

#### NFR-005：可扩展性要求
- 插件式架构支持新存储后端
- 模板系统支持社区扩展
- 数据格式向后兼容

---

## 三、用户故事

### 3.1 核心场景

**US-001：技术文档摘录**
> 作为一名程序员，我在阅读 MDN 文档时，想要摘录某个 API 的说明，添加标签"JavaScript"和"Web API"，保存到我的技术笔记目录（`/notes/tech/js/`），以便后续查阅。

**预期操作流程**：
1. 选中文档中的核心段落
2. 右键 → "摘录选中内容"
3. 预览界面出现，自动填充标题
4. 添加标签：JavaScript、Web API
5. 选择分类：技术文档
6. 选择保存位置：WebDAV → `/notes/tech/js/`
7. 点击"保存"

**US-002：多段内容整合**
> 作为一名研究者，我在阅读一篇长文时，想要摘录分散在不同段落的 3 个关键观点，合并成一个文件保存。

**预期操作流程**：
1. 点击插件图标 → "多段选择模式"
2. 点击第一个段落（高亮显示）
3. Shift+点击第二个段落（累加选择）
4. Shift+点击第三个段落
5. 点击"完成选择"
6. 预览界面显示 3 个段落（按选择顺序）
7. 编辑、添加标签、保存

**US-003：全页保存带图片**
> 作为一名设计师，我在浏览设计博客时，想要保存整篇文章和所有图片，以便离线查看。

**预期操作流程**：
1. 点击插件图标 → "保存整个页面"
2. 等待页面滚动完成（自动触发懒加载）
3. 预览界面出现，勾选"下载图片"
4. 选择保存位置：本地 → 选择文件夹
5. 点击"保存"
6. 后台下载图片，显示进度
7. 完成后通知用户

**US-004：跨设备同步**
> 作为一名知识工作者，我在公司电脑上摘录了一些资料，回家后希望在家里的电脑上也能看到这些记录。

**预期操作流程**：
1. 公司电脑：启用配置同步和历史同步
2. 摘录内容自动保存到 WebDAV
3. 回家后打开浏览器
4. 插件自动从 WebDAV 下载配置
5. 点击"同步历史记录"
6. 本地和远端历史合并
7. 查看所有记录

### 3.2 边缘场景

**US-005：网络中断处理**
- 保存到 WebDAV 时网络断开
- 预期：提示错误，保存到本地队列
- 恢复网络后重新上传

**US-006：文件冲突**
- 保存时发现 WebDAV 已存在同名文件
- 预期：提示用户选择（覆盖/重命名/取消）

**US-007：大文件处理**
- 页面内容超过 10MB（大量图片）
- 预期：提示用户，支持分块上传

---

## 四、约束条件

### 4.1 技术约束

1. **浏览器限制**
   - Manifest V3 的 Service Worker 每 5 分钟休眠
   - 不能有持久化后台页面
   - chrome.alarms 最小间隔 1 分钟

2. **存储限制**
   - browser.storage.local 默认配额：5MB（可申请无限）
   - IndexedDB 可用于大量历史记录

3. **跨域限制**
   - Content Script 无法直接下载跨域图片
   - 必须通过 Background Script 中转

### 4.2 业务约束

1. **隐私优先**
   - 不使用第三方分析服务
   - 不上传用户数据到非用户指定的服务器

2. **开源协议**
   - 使用 MIT 或 GPL-3.0 许可证
   - 允许社区贡献

3. **资源限制**
   - 开发周期：3 个月（MVP）
   - 团队规模：1-2 人
   - 预算：开源项目（无商业预算）

---

## 五、成功指标

### 5.1 功能指标

- [ ] 支持 90% 以上主流网站的内容提取
- [ ] 懒加载页面处理成功率 > 85%
- [ ] WebDAV 上传成功率 > 95%（排除网络故障）
- [ ] 历史记录同步成功率 > 99%

### 5.2 用户体验指标

- [ ] 首次使用完成配置时间 < 3 分钟
- [ ] 平均摘录时间 < 30 秒（从选择到保存完成）
- [ ] 用户满意度 > 4.0/5.0
- [ ] 留存率（30 天）> 60%

### 5.3 技术指标

- [ ] 代码测试覆盖率 > 80%
- [ ] 关键路径性能达标（见 NFR-001）
- [ ] 无严重安全漏洞（OWASP Top 10）
- [ ] 向后兼容性（至少 1 个大版本）

---

## 六、里程碑规划

### Phase 1: MVP（4 周）
- Week 1-2: 基础架构 + 内容提取
  - 项目脚手架
  - Content Extractor（全页/局部）
  - Markdown 转换器
- Week 3: 保存功能
  - 本地保存
  - WebDAV 保存
  - 预览 Modal
- Week 4: 历史记录
  - 记录管理
  - 搜索和过滤

### Phase 2: 增强功能（4 周）
- Week 5-6: 多段选择 + 懒加载
  - 多段选择 UI
  - 懒加载检测和处理
- Week 7: 元数据系统
  - 标签和分类
  - 模板系统
- Week 8: 图片下载
  - 批量下载
  - 后台处理

### Phase 3: 同步功能（4 周）
- Week 9-10: 配置同步
  - 上传/下载配置
  - 冲突解决
- Week 11-12: 历史同步
  - 数据合并
  - 自动同步

---

## 七、风险评估

### 高风险

1. **懒加载处理复杂性**
   - 风险：不同网站实现方式不同，难以统一处理
   - 缓解：使用成熟库（defuddle），提供手动触发选项

2. **Service Worker 生命周期**
   - 风险：自动同步不可靠
   - 缓解：设计为手动同步为主，自动同步为辅

### 中风险

3. **WebDAV 兼容性**
   - 风险：不同服务器实现差异
   - 缓解：测试主流服务（Nextcloud、Synology、坚果云）

4. **历史记录合并冲突**
   - 风险：复杂的冲突场景难以处理
   - 缓解：使用简单策略（最新优先），提供手动解决选项

### 低风险

5. **浏览器兼容性**
   - 风险：Firefox 和 Chrome API 差异
   - 缓解：使用 webextension-polyfill

---

## 八、未来展望

### 短期（6 个月内）
- AI 辅助标签建议
- 模板市场和社区分享
- 移动端优化（Firefox Mobile）

### 中期（12 个月内）
- 插件式架构支持 GitHub 存储
- 插件式架构支持 Notion 存储
- OCR 图片文字识别

### 长期（18 个月+）
- 知识图谱可视化
- 智能推荐相关内容
- 团队协作功能

---

## 附录

### A. 术语表

| 术语 | 定义 |
|------|------|
| Web Clipper | 网页剪藏工具，用于保存网页内容 |
| Markdown | 轻量级标记语言，易读易写 |
| WebDAV | 基于 HTTP 的文件共享协议 |
| Lazy Loading | 懒加载，按需加载内容（通常指图片） |
| Manifest V3 | Chrome 扩展的新版本规范 |
| Service Worker | 后台脚本，处理事件驱动任务 |
| Content Script | 注入到网页中的脚本 |
| Turndown | HTML 到 Markdown 的转换库 |

### B. 参考资料

1. Obsidian Web Clipper - https://github.com/obsidianmd/obsidian-clipper
2. Manifest V3 文档 - https://developer.chrome.com/docs/extensions/mv3/
3. WebDAV 规范 - https://tools.ietf.org/html/rfc4918
4. Turndown - https://github.com/mixmark-io/turndown

---

**文档状态**：草稿
**最后更新**：2025-01-25
**审核状态**：待审核
